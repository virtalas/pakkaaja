<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fi"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HuffmanCoder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pakkaaja</a> &gt; <a href="index.source.html" class="el_package">main.java.huffman</a> &gt; <span class="el_source">HuffmanCoder.java</span></div><h1>HuffmanCoder.java</h1><pre class="source lang-java linenums">package main.java.huffman;

import java.util.PriorityQueue;
import main.java.io.FileInput;
import main.java.io.FileOutput;

/**
 * Implements the Huffman coding and writes the compressed file.
 */
public class HuffmanCoder {

    /**
     * An integer array where the index represents the character/byte, and the
     * value represents the frequency of the character/byte.
     */
    private final int[] byteFrequencies;

    /**
     * A string array where the index represents the character/byte, and the
     * value represents the huffman code of the character/byte.
     */
    public String[] codes;

    /**
     * Initializes byteFrequencies and codes.
     *
     * @param bytes array of character/byte frequencies
     * @param alphabetSize size of the alphabet, or how many unique characters
     * there can be.
     */
<span class="fc" id="L31">    public HuffmanCoder(int[] bytes, int alphabetSize) {</span>
<span class="fc" id="L32">        this.byteFrequencies = bytes;</span>
<span class="fc" id="L33">        this.codes = new String[alphabetSize];</span>
<span class="fc" id="L34">    }</span>

    /**
     * Run the Huffman coding algorithm and write the compressed file.
     * Writes the Huffman tree first and then the compressed content.
     *
     * @param sourcePath path of the source file
     * @param destinationPath path of the destination file
     */
    public void compress(String sourcePath, String destinationPath) {
<span class="nc" id="L44">        HuffmanTree root = buildTree();</span>
<span class="nc" id="L45">        buildCodeList(root, new StringBuffer());</span>

<span class="nc" id="L47">        FileOutput out = new FileOutput(destinationPath);</span>

<span class="nc" id="L49">        writeTree(out, root);</span>
<span class="nc" id="L50">        writeCompressedContent(sourcePath, out);</span>
<span class="nc" id="L51">        out.close();</span>
<span class="nc" id="L52">    }</span>

    /**
     * Reads the source file and writes the compressed destination file using
     * huffman codes.
     *
     * @param sourcePath path of the source file
     * @param destinationPath path of the destination file
     */
    public void writeCompressedContent(String sourcePath, FileOutput out) {
<span class="nc" id="L62">        FileInput in = new FileInput(sourcePath);</span>

<span class="nc" id="L64">        int readByte = in.readByte();</span>

<span class="nc bnc" id="L66" title="All 2 branches missed.">        while (readByte != -1) {</span>
<span class="nc" id="L67">            out.writeBits(codes[readByte]);</span>
<span class="nc" id="L68">            readByte = in.readByte();</span>
        }
<span class="nc" id="L70">        in.close();</span>
<span class="nc" id="L71">    }</span>

    /**
     * First the structure of the tree is written, ending with the output at the beginning of the next byte.
     * Then the leaf values are written, one value per byte.
     * 
     * @param out FileOutput for the bits.
     * @param root Root of the tree to be written.
     */
    public void writeTree(FileOutput out, HuffmanTree root) {
<span class="nc" id="L81">        writeTreeStructure(out, root);</span>
<span class="nc" id="L82">        out.advanceToNextByte();</span>
<span class="nc" id="L83">        writeTreeLeaves(out, root);</span>
<span class="nc" id="L84">    }</span>

    /**
     * Traverses the tree in pre-order and writes 0 for leaf, 1 for internal node.
     * 
     * @param out FileOutput for the bits.
     * @param tree subtree to be written and traversed
     */
    public void writeTreeStructure(FileOutput out, HuffmanTree tree) {
<span class="nc bnc" id="L93" title="All 2 branches missed.">        if (tree instanceof HuffmanLeaf) {</span>
<span class="nc" id="L94">            out.writeBit(0);</span>
        } else {
<span class="nc" id="L96">            out.writeBit(1);</span>
<span class="nc" id="L97">            HuffmanInternalNode node = (HuffmanInternalNode) tree;</span>
<span class="nc" id="L98">            writeTreeStructure(out, node.left);</span>
<span class="nc" id="L99">            writeTreeStructure(out, node.right);</span>
        }
<span class="nc" id="L101">    }</span>

    /**
     * Traverses the tree in pre-order and writes leaf values, one value/leaf per byte.
     * 
     * @param out FileOutput for the bytes.
     * @param tree subtree to be written and traversed
     */
    public void writeTreeLeaves(FileOutput out, HuffmanTree tree) {
<span class="nc bnc" id="L110" title="All 2 branches missed.">        if (tree instanceof HuffmanLeaf) {</span>
<span class="nc" id="L111">            HuffmanLeaf leaf = (HuffmanLeaf) tree;</span>
<span class="nc" id="L112">                out.writeByte(leaf.value);</span>
<span class="nc" id="L113">        } else {</span>
<span class="nc" id="L114">            HuffmanInternalNode node = (HuffmanInternalNode) tree;</span>
<span class="nc" id="L115">            writeTreeLeaves(out, node.left);</span>
<span class="nc" id="L116">            writeTreeLeaves(out, node.right);</span>
        }
<span class="nc" id="L118">    }</span>

    /**
     * Builds the Huffman tree by combining the least frequent trees until the
     * tree is complete.
     *
     * @return the root of the tree
     */
    public HuffmanTree buildTree() {
<span class="fc" id="L127">        PriorityQueue&lt;HuffmanTree&gt; trees = new PriorityQueue&lt;HuffmanTree&gt;();</span>
        // Initially, there are only leaves, one for each non-empty character
<span class="fc bfc" id="L129" title="All 2 branches covered.">        for (int i = 0; i &lt; byteFrequencies.length; i++) {</span>
<span class="pc bpc" id="L130" title="1 of 2 branches missed.">            if (byteFrequencies[i] &gt; 0) {</span>
<span class="fc" id="L131">                trees.offer(new HuffmanLeaf(byteFrequencies[i], (char) i));</span>
            }
        }

        // Loop until there is only one tree left
<span class="fc bfc" id="L136" title="All 2 branches covered.">        while (trees.size() &gt; 1) {</span>
            // two trees with least frequency
<span class="fc" id="L138">            HuffmanTree a = trees.poll();</span>
<span class="fc" id="L139">            HuffmanTree b = trees.poll();</span>

            // Put into new node and re-insert into queue
<span class="fc" id="L142">            trees.offer(new HuffmanInternalNode(a, b));</span>
<span class="fc" id="L143">        }</span>
<span class="fc" id="L144">        return trees.poll();</span>
    }

    /**
     * Builds an array of characters and their corresponding Huffman codes
     *
     * @param tree complete Huffman tree
     * @param prefix initializes the prefix/code
     */
    public void buildCodeList(HuffmanTree tree, StringBuffer prefix) {
<span class="fc bfc" id="L154" title="All 2 branches covered.">        if (tree instanceof HuffmanLeaf) {</span>
<span class="fc" id="L155">            HuffmanLeaf leaf = (HuffmanLeaf) tree;</span>

<span class="fc" id="L157">            System.out.println(leaf.value + &quot;\t&quot; + leaf.frequency + &quot;\t&quot; + prefix);</span>

<span class="fc" id="L159">            codes[leaf.value] = prefix.toString();</span>

<span class="pc bpc" id="L161" title="1 of 2 branches missed.">        } else if (tree instanceof HuffmanInternalNode) {</span>
<span class="fc" id="L162">            HuffmanInternalNode node = (HuffmanInternalNode) tree;</span>

            // Traverse left
<span class="fc" id="L165">            prefix.append('0');</span>
<span class="fc" id="L166">            buildCodeList(node.left, prefix);</span>
<span class="fc" id="L167">            prefix.deleteCharAt(prefix.length() - 1);</span>

            // Traverse right
<span class="fc" id="L170">            prefix.append('1');</span>
<span class="fc" id="L171">            buildCodeList(node.right, prefix);</span>
<span class="fc" id="L172">            prefix.deleteCharAt(prefix.length() - 1);</span>
        }
<span class="fc" id="L174">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>